<!-- Views/CraneUsage/Form.cshtml -->
@model AspnetCoreMvcFull.ViewModels.CraneUsage.CraneUsageFormViewModel

@{
  ViewData["Title"] = "Input Penggunaan Crane";
  Layout = "_ContentNavbarLayout";
}

<div class="container-fluid">
  <h1 class="mt-4">Input Penggunaan Crane</h1>
  <p class="lead">Catat penggunaan crane dalam satu hari</p>

  @if (TempData["SuccessMessage"] != null)
  {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      @TempData["SuccessMessage"]
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  }

  @if (TempData["ErrorMessage"] != null)
  {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      @TempData["ErrorMessage"]
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  }

  <div class="card mb-4">
    <div class="card-header">
      <i class="fas fa-calendar-day me-1"></i>
      Pilih Crane dan Tanggal
    </div>
    <div class="card-body">
      <form id="craneFormSelector" asp-action="Form" method="get">
        <div class="row g-3">
          <div class="col-md-4">
            <label asp-for="CraneId" class="form-label">Crane</label>
            <select asp-for="CraneId" asp-items="Model.CraneList" class="form-select" required>
              <option value="">-- Pilih Crane --</option>
            </select>
          </div>
          <div class="col-md-4">
            <label asp-for="Date" class="form-label">Tanggal</label>
            <input asp-for="Date" type="date" class="form-control" required />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search me-1"></i> Tampilkan
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  @if (Model.CraneId > 0)
  {
    <form id="usageForm" asp-action="Form" method="post">
      <input type="hidden" asp-for="CraneId" />
      <input type="hidden" asp-for="Date" />

      <div class="card mb-4">
        <div class="card-header">
          <i class="fas fa-user me-1"></i>
          Informasi Operator
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label asp-for="OperatorName" class="form-label">Nama Operator</label>
              <input asp-for="OperatorName" class="form-control" required />
              <span asp-validation-for="OperatorName" class="text-danger"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <i class="fas fa-clock me-1"></i>
            Daftar Penggunaan Waktu
          </div>
          <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addEntryModal">
            <i class="fas fa-plus me-1"></i> Tambah Penggunaan
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-hover" id="entriesTable">
              <thead class="table-light">
                <tr>
                  <th>Jam Mulai</th>
                  <th>Jam Selesai</th>
                  <th>Kategori</th>
                  <th>Subkategori</th>
                  <th>Booking/Maintenance</th>
                  <th>Catatan</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="entriesTableBody">
                @if (Model.Entries != null && Model.Entries.Any())
                {
                  @for (int i = 0; i < Model.Entries.Count; i++)
                  {
                    var entry = Model.Entries[i];
                    <tr data-entry-id="@entry.Id">
                      <td>@entry.StartTime.ToString(@"hh\:mm")</td>
                      <td>@entry.EndTime.ToString(@"hh\:mm")</td>
                      <td>
                        <span class="badge" style="background-color: @GetCategoryColor(entry.Category)">
                          @entry.CategoryName
                        </span>
                      </td>
                      <td>@entry.SubcategoryName</td>
                      <td>
                        @if (!string.IsNullOrEmpty(entry.BookingNumber))
                        {
                          <span class="badge bg-primary">Booking: @entry.BookingNumber</span>
                        }
                        @if (!string.IsNullOrEmpty(entry.MaintenanceTitle))
                        {
                          <span class="badge bg-info">Maintenance: @entry.MaintenanceTitle</span>
                        }
                      </td>
                      <td>@entry.Notes</td>
                      <td>
                        <div class="btn-group">
                          <button type="button" class="btn btn-sm btn-warning text-white edit-entry" data-id="@entry.Id"
                            data-start="@entry.StartTime.ToString(@"hh\:mm")" data-end="@entry.EndTime.ToString(@"hh\:mm")"
                            data-category="@((int)entry.Category)" data-subcategory="@entry.UsageSubcategoryId"
                            data-booking="@entry.BookingId" data-maintenance="@entry.MaintenanceScheduleId"
                            data-notes="@entry.Notes">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button type="button" class="btn btn-sm btn-danger delete-entry" data-id="@entry.Id">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>

                      <input type="hidden" name="Entries[@i].Id" value="@entry.Id" />
                      <input type="hidden" name="Entries[@i].StartTime" value="@entry.StartTime" />
                      <input type="hidden" name="Entries[@i].EndTime" value="@entry.EndTime" />
                      <input type="hidden" name="Entries[@i].Category" value="@((int)entry.Category)" />
                      <input type="hidden" name="Entries[@i].UsageSubcategoryId" value="@entry.UsageSubcategoryId" />
                      <input type="hidden" name="Entries[@i].BookingId" value="@entry.BookingId" />
                      <input type="hidden" name="Entries[@i].MaintenanceScheduleId" value="@entry.MaintenanceScheduleId" />
                      <input type="hidden" name="Entries[@i].Notes" value="@entry.Notes" />
                    </tr>
                  }
                }
                else
                {
                  <tr id="noEntriesRow">
                    <td colspan="7" class="text-center">Belum ada data penggunaan. Klik "Tambah Penggunaan" untuk
                      menambahkan.</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Simpan Semua Perubahan
          </button>
          <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Kembali ke Daftar
          </a>
        </div>
      </div>
    </form>

    <!-- Modal for Adding Entry -->
    <div class="modal fade" id="addEntryModal" tabindex="-1" aria-labelledby="addEntryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addEntryModalLabel">Tambah Penggunaan Crane</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="entryForm">
              <input type="hidden" id="entryId" value="0" />

              <!-- Perubahan di Views/CraneUsage/Form.cshtml pada bagian modal form -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="startTime" class="form-label">Jam Mulai</label>
                    <input type="time" id="startTime" class="form-control" required />
                    <div class="invalid-feedback">Jam mulai harus diisi.</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="endTime" class="form-label">Jam Selesai</label>
                    <input type="time" id="endTime" class="form-control" required />
                    <div class="invalid-feedback">Jam selesai harus diisi.</div>
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="category" class="form-label">Kategori</label>
                    <select id="category" class="form-select" required>
                      <option value="">-- Pilih Kategori --</option>
                      @foreach (var category in Enum.GetValues(typeof(UsageCategory)))
                      {
                        <option value="@((int)category)">@category</option>
                      }
                    </select>
                    <div class="invalid-feedback">Kategori harus dipilih.</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="subcategory" class="form-label">Subkategori</label>
                    <select id="subcategory" class="form-select" required>
                      <option value="">-- Pilih Subkategori --</option>
                    </select>
                    <div class="invalid-feedback">Subkategori harus dipilih.</div>
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="booking" class="form-label">Booking (opsional)</label>
                    <select id="booking" class="form-select">
                      <option value="">-- Tidak ada booking terkait --</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="maintenance" class="form-label">Maintenance (opsional)</label>
                    <select id="maintenance" class="form-select">
                      <option value="">-- Tidak ada maintenance terkait --</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="notes" class="form-label">Catatan (opsional)</label>
                <textarea id="notes" class="form-control" rows="3"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-primary" id="saveEntryBtn">Simpan</button>
          </div>
        </div>
      </div>
    </div>
  }
  else
  {
    <div class="alert alert-info">
      <i class="fas fa-info-circle me-2"></i>
      Silakan pilih crane dan tanggal untuk melihat atau menambahkan data penggunaan.
    </div>
  }
</div>

@functions {
  public string GetCategoryColor(UsageCategory category)
  {
    return category switch
    {
      UsageCategory.Operating => "#28a745", // Green
      UsageCategory.Delay => "#ffc107", // Yellow
      UsageCategory.Standby => "#6c757d", // Gray
      UsageCategory.Service => "#17a2b8", // Cyan
      UsageCategory.Breakdown => "#dc3545", // Red
      _ => "#6c757d" // Default Gray
    };
  }
}

@section PageScripts {
  @* @{
    await Html.RenderPartialAsync("_ValidationScriptsPartial");
  } *@

  <script>
    $(document).ready(function () {
      var isEditMode = false;
      var entryCount = @Model.Entries.Count;

      // Load subcategories when category changes
      $('#category').change(function () {
        var categoryId = $(this).val();
        if (categoryId) {
          $('#subcategory').html('<option value="">Loading...</option>');

          $.getJSON('@Url.Action("GetSubcategories")?category=' + categoryId, function (data) {
            var subcategorySelect = $('#subcategory');
            subcategorySelect.empty();
            subcategorySelect.append($('<option></option>').val('').text('-- Pilih Subkategori --'));
            $.each(data, function (index, item) {
              subcategorySelect.append($('<option></option>').val(item.value).text(item.text));
            });
          });
        }
      });

      // Load related bookings and maintenance when time changes
      function updateRelatedItems() {
        var craneId = '@Model.CraneId';
        var date = '@Model.Date.ToString("yyyy-MM-dd")';
        var startTime = $('#startTime').val();
        var endTime = $('#endTime').val();

        if (!craneId || !date || !startTime || !endTime) {
          return;
        }

        // Show loading indicators
        $('#booking').html('<option value="">Loading bookings...</option>');
        $('#maintenance').html('<option value="">Loading maintenance...</option>');

        // Get related bookings
        $.getJSON('@Url.Action("GetRelatedBookings")?craneId=' + craneId +
          '&date=' + date +
          '&startTime=' + startTime +
          '&endTime=' + endTime,
          function (data) {
            var bookingSelect = $('#booking');
            bookingSelect.empty();
            bookingSelect.append($('<option></option>').val('').text('-- Tidak ada booking terkait --'));
            $.each(data, function (index, item) {
              bookingSelect.append($('<option></option>').val(item.value).text(item.text));
            });
          });

        // Get related maintenance
        $.getJSON('@Url.Action("GetRelatedMaintenance")?craneId=' + craneId +
          '&date=' + date +
          '&startTime=' + startTime +
          '&endTime=' + endTime,
          function (data) {
            var maintenanceSelect = $('#maintenance');
            maintenanceSelect.empty();
            maintenanceSelect.append($('<option></option>').val('').text('-- Tidak ada maintenance terkait --'));
            $.each(data, function (index, item) {
              maintenanceSelect.append($('<option></option>').val(item.value).text(item.text));
            });
          });
      }

      $('#startTime, #endTime').change(updateRelatedItems);

      // Initialize modal on show
      $('#addEntryModal').on('show.bs.modal', function (e) {
        if (!isEditMode) {
          // Reset form for adding new entry
          $('#entryForm')[0].reset();
          $('#entryId').val(0);
          $('#addEntryModalLabel').text('Tambah Penggunaan Crane');

          // Set default values
          $('#startTime').val('08:00');
          $('#endTime').val('09:00');
          $('#category').val('');
          $('#subcategory').empty().append($('<option></option>').val('').text('-- Pilih Subkategori --'));
          $('#booking').empty().append($('<option></option>').val('').text('-- Tidak ada booking terkait --'));
          $('#maintenance').empty().append($('<option></option>').val('').text('-- Tidak ada maintenance terkait --'));
          $('#notes').val('');
        }
      });

      // Save entry button click
      $('#saveEntryBtn').click(function () {
        // Validate form
        var form = $('#entryForm')[0];
        if (!form.checkValidity()) {
          $(form).addClass('was-validated');
          return;
        }

        var entryId = $('#entryId').val();
        var startTime = $('#startTime').val();
        var endTime = $('#endTime').val();
        var category = $('#category').val();
        var subcategory = $('#subcategory').val();
        var booking = $('#booking').val();
        var maintenance = $('#maintenance').val();
        var notes = $('#notes').val();

        // Validate times
        if (startTime >= endTime) {
          alert('Jam mulai harus lebih awal dari jam selesai.');
          return;
        }

        // Prepare entry data
        var entryData = {
          Id: entryId !== '0' ? parseInt(entryId) : 0,
          StartTime: startTime,
          EndTime: endTime,
          Category: parseInt(category),
          UsageSubcategoryId: parseInt(subcategory),
          BookingId: booking ? parseInt(booking) : null,
          MaintenanceScheduleId: maintenance ? parseInt(maintenance) : null,
          Notes: notes
        };

        // Either add new or update existing entry
        if (isEditMode) {
          // Update existing entry
          $.ajax({
            url: '@Url.Action("UpdateEntry")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(entryData),
            success: function (response) {
              if (response.success) {
                // Update the row in the table
                updateTableRow(response.entry);

                // Close modal
                $('#addEntryModal').modal('hide');

                // Reset edit mode
                isEditMode = false;
              } else {
                alert(response.message);
              }
            },
            error: function () {
              alert('Terjadi kesalahan saat memperbarui data.');
            }
          });
        } else {
          // Add new entry
          $.ajax({
            url: '@Url.Action("AddEntry")',
            type: 'POST',
            data: {
              entry: entryData,
              craneId: '@Model.CraneId',
              date: '@Model.Date.ToString("yyyy-MM-dd")',
              operatorName: $('#OperatorName').val()
            },
            success: function (response) {
              if (response.success) {
                // Add the row to the table
                addTableRow(response.entry);

                // Close modal
                $('#addEntryModal').modal('hide');
              } else {
                alert(response.message);
              }
            },
            error: function () {
              alert('Terjadi kesalahan saat menambahkan data.');
            }
          });
        }
      });

      // Edit entry button click
      $(document).on('click', '.edit-entry', function () {
        isEditMode = true;

        // Get entry data from button data attributes
        var id = $(this).data('id');
        var startTime = $(this).data('start');
        var endTime = $(this).data('end');
        var category = $(this).data('category');
        var subcategory = $(this).data('subcategory');
        var booking = $(this).data('booking');
        var maintenance = $(this).data('maintenance');
        var notes = $(this).data('notes');

        // Set form values
        $('#entryId').val(id);
        $('#startTime').val(startTime);
        $('#endTime').val(endTime);
        $('#category').val(category);
        $('#notes').val(notes);

        // Load subcategories
        $('#category').trigger('change');

        // Set timeout to allow subcategories to load
        setTimeout(function () {
          $('#subcategory').val(subcategory);

          // Load related bookings and maintenance
          updateRelatedItems();

          // Set timeout to allow bookings and maintenance to load
          setTimeout(function () {
            if (booking) {
              $('#booking').val(booking);
            }
            if (maintenance) {
              $('#maintenance').val(maintenance);
            }
          }, 500);
        }, 500);

        // Update modal title
        $('#addEntryModalLabel').text('Edit Penggunaan Crane');

        // Show modal
        $('#addEntryModal').modal('show');
      });

      // Delete entry button click
      $(document).on('click', '.delete-entry', function () {
        if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
          var id = $(this).data('id');
          var row = $(this).closest('tr');

          // Only send delete request for existing entries (ID > 0)
          if (id > 0) {
            $.ajax({
              url: '@Url.Action("DeleteEntry")',
              type: 'POST',
              data: { id: id },
              success: function (response) {
                if (response.success) {
                  // Remove the row from the table
                  row.remove();

                  // If no entries remain, show "no entries" row
                  if ($('#entriesTableBody tr').length === 0) {
                    $('#entriesTableBody').html('<tr id="noEntriesRow"><td colspan="7" class="text-center">Belum ada data penggunaan. Klik "Tambah Penggunaan" untuk menambahkan.</td></tr>');
                  }

                  // Re-index the remaining entries
                  reindexEntries();
                } else {
                  alert('Gagal menghapus data: ' + (response.message || 'Terjadi kesalahan'));
                }
              },
              error: function () {
                alert('Terjadi kesalahan saat menghapus data.');
              }
            });
          } else {
            // Just remove the row for new entries
            row.remove();

            // If no entries remain, show "no entries" row
            if ($('#entriesTableBody tr').length === 0) {
              $('#entriesTableBody').html('<tr id="noEntriesRow"><td colspan="7" class="text-center">Belum ada data penggunaan. Klik "Tambah Penggunaan" untuk menambahkan.</td></tr>');
            }

            // Re-index the remaining entries
            reindexEntries();
          }
        }
      });

      // Function to add a new row to the table
      function addTableRow(entry) {
        // Remove "no entries" row if it exists
        $('#noEntriesRow').remove();

        var index = entryCount++;
        var categoryColor = getCategoryColor(entry.category);

        var relatedItems = '';
        if (entry.bookingNumber) {
          relatedItems += '<span class="badge bg-primary">Booking: ' + entry.bookingNumber + '</span> ';
        }
        if (entry.maintenanceTitle) {
          relatedItems += '<span class="badge bg-info">Maintenance: ' + entry.maintenanceTitle + '</span>';
        }

        var newRow = `
                              <tr data-entry-id="${entry.id}">
                                  <td>${formatTime(entry.startTime)}</td>
                                  <td>${formatTime(entry.endTime)}</td>
                                  <td>
                                      <span class="badge" style="background-color: ${categoryColor}">
                                          ${entry.categoryName}
                                      </span>
                                  </td>
                                  <td>${entry.subcategoryName}</td>
                                  <td>${relatedItems}</td>
                                  <td>${entry.notes || ''}</td>
                                  <td>
                                      <div class="btn-group">
                                          <button type="button" class="btn btn-sm btn-warning text-white edit-entry"
                                                  data-id="${entry.id}"
                                                  data-start="${formatTime(entry.startTime)}"
                                                  data-end="${formatTime(entry.endTime)}"
                                                  data-category="${entry.category}"
                                                  data-subcategory="${entry.usageSubcategoryId}"
                                                  data-booking="${entry.bookingId || ''}"
                                                  data-maintenance="${entry.maintenanceScheduleId || ''}"
                                                  data-notes="${entry.notes || ''}">
                                              <i class="fas fa-edit"></i>
                                          </button>
                                          <button type="button" class="btn btn-sm btn-danger delete-entry" data-id="${entry.id}">
                                              <i class="fas fa-trash"></i>
                                          </button>
                                      </div>
                                  </td>

                                  <input type="hidden" name="Entries[${index}].Id" value="${entry.id}" />
                                  <input type="hidden" name="Entries[${index}].StartTime" value="${entry.startTime}" />
                                  <input type="hidden" name="Entries[${index}].EndTime" value="${entry.endTime}" />
                                  <input type="hidden" name="Entries[${index}].Category" value="${entry.category}" />
                                  <input type="hidden" name="Entries[${index}].UsageSubcategoryId" value="${entry.usageSubcategoryId}" />
                                  <input type="hidden" name="Entries[${index}].BookingId" value="${entry.bookingId || ''}" />
                                  <input type="hidden" name="Entries[${index}].MaintenanceScheduleId" value="${entry.maintenanceScheduleId || ''}" />
                                  <input type="hidden" name="Entries[${index}].Notes" value="${entry.notes || ''}" />
                              </tr>
                              `;

        $('#entriesTableBody').append(newRow);
      }

      // Function to update an existing row in the table
      function updateTableRow(entry) {
        var row = $(`tr[data-entry-id="${entry.id}"]`);
        var categoryColor = getCategoryColor(entry.category);

        var relatedItems = '';
        if (entry.bookingNumber) {
          relatedItems += '<span class="badge bg-primary">Booking: ' + entry.bookingNumber + '</span> ';
        }
        if (entry.maintenanceTitle) {
          relatedItems += '<span class="badge bg-info">Maintenance: ' + entry.maintenanceTitle + '</span>';
        }

        // Update visible cells
        row.find('td').eq(0).text(formatTime(entry.startTime));
        row.find('td').eq(1).text(formatTime(entry.endTime));
        row.find('td').eq(2).html(`<span class="badge" style="background-color: ${categoryColor}">${entry.categoryName}</span>`);
        row.find('td').eq(3).text(entry.subcategoryName);
        row.find('td').eq(4).html(relatedItems);
        row.find('td').eq(5).text(entry.notes || '');

        // Update data attributes for edit button
        var editButton = row.find('.edit-entry');
        editButton.data('start', formatTime(entry.startTime));
        editButton.data('end', formatTime(entry.endTime));
        editButton.data('category', entry.category);
        editButton.data('subcategory', entry.usageSubcategoryId);
        editButton.data('booking', entry.bookingId || '');
        editButton.data('maintenance', entry.maintenanceScheduleId || '');
        editButton.data('notes', entry.notes || '');

        // Update hidden inputs
        row.find('input[name$=".StartTime"]').val(entry.startTime);
        row.find('input[name$=".EndTime"]').val(entry.endTime);
        row.find('input[name$=".Category"]').val(entry.category);
        row.find('input[name$=".UsageSubcategoryId"]').val(entry.usageSubcategoryId);
        row.find('input[name$=".BookingId"]').val(entry.bookingId || '');
        row.find('input[name$=".MaintenanceScheduleId"]').val(entry.maintenanceScheduleId || '');
        row.find('input[name$=".Notes"]').val(entry.notes || '');
      }

      // Function to re-index the entries in the form
      function reindexEntries() {
        $('#entriesTableBody tr').each(function (index) {
          $(this).find('input[name^="Entries["]').each(function () {
            var name = $(this).attr('name');
            var newName = name.replace(/Entries\[\d+\]/, `Entries[${index}]`);
            $(this).attr('name', newName);
          });
        });
      }

      // Helper function to get category color
      function getCategoryColor(category) {
        var colors = {
          0: '#28a745', // Operating (Green)
          1: '#ffc107', // Delay (Yellow)
          2: '#6c757d', // Standby (Gray)
          3: '#17a2b8', // Service (Cyan)
          4: '#dc3545'  // Breakdown (Red)
        };

        return colors[category] || '#6c757d';
      }

      // Di dalam script di bawah form
      // Fungsi formatTime yang akan menampilkan waktu dengan benar
      function formatTime(timeString) {
        // If it's already in HH:MM format, return as is
        if (/^\d{2}:\d{2}$/.test(timeString)) {
          return timeString;
        }

        // Try to parse TimeSpan format
        try {
          var parts = timeString.split(':');
          if (parts.length >= 2) {
            var hours = parts[0].padStart(2, '0');
            var minutes = parts[1].padStart(2, '0');
            return `${hours}:${minutes}`;
          }
        } catch (e) {
          console.error('Error formatting time:', e);
        }

        return timeString; // Return original if parsing fails
      }
    });
  </script>
}
