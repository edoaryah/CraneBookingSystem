@model AspnetCoreMvcFull.ViewModels.CraneUsage.CraneUsageRecordListViewModel
@{
  ViewData["Title"] = "Crane Usage Records";
  Layout = "_ContentNavbarLayout";
}

<!-- Filter Card -->
<div class="card mb-4">
  <div class="card-header">
    <i class="bx bx-filter-alt me-1"></i>
    Filter
  </div>
  <div class="card-body">
    <form asp-action="Index" method="get" id="filterForm">
      <div class="row g-3">
        <div class="col-md-4">
          <label asp-for="Filter.CraneId" class="form-label">Crane</label>
          <select asp-for="Filter.CraneId" asp-items="Model.Filter.CraneList" class="form-select"
            onchange="document.getElementById('filterForm').submit()">
            <option value="">-- All Cranes --</option>
          </select>
        </div>
        <div class="col-md-4">
          <label asp-for="Filter.StartDate" class="form-label">Start Date</label>
          <input asp-for="Filter.StartDate" class="form-control" type="date"
            onchange="document.getElementById('filterForm').submit()" />
        </div>
        <div class="col-md-4">
          <label asp-for="Filter.EndDate" class="form-label">End Date</label>
          <input asp-for="Filter.EndDate" class="form-control" type="date"
            onchange="document.getElementById('filterForm').submit()" />
        </div>
        <div class="col-md-12 d-flex justify-content-end mt-2">
          <a href="@Url.Action("Index")" class="btn btn-outline-secondary btn-sm">
            <i class="bx bx-reset me-1"></i> Reset Filter
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Records Table Card -->
<div class="card">
  <div class="card-header">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
      <div class="mb-2 mb-md-0">
        <i class="bx bx-table me-1"></i>
        Crane Usage Records
      </div>
      <div class="d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#craneSelectionModal">
          <i class="bx bx-plus me-1"></i> Form
        </button>
        <a asp-action="MinuteVisualization" class="btn btn-info text-white">
          <i class="bx bx-bar-chart-alt-2 me-1"></i> Visualization
        </a>
      </div>
    </div>
  </div>

  @if (ViewBag.SuccessMessage != null)
  {
    <div class="alert alert-success alert-dismissible mx-4 mt-4" role="alert">
      @ViewBag.SuccessMessage
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  }

  @if (ViewBag.ErrorMessage != null)
  {
    <div class="alert alert-danger alert-dismissible mx-4 mt-4" role="alert">
      @ViewBag.ErrorMessage
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  }

  @if (Model.Records != null && Model.Records.Any())
  {
    <div class="table-responsive text-nowrap">
      <table class="table table-hover" id="usageTable">
        <thead>
          <tr>
            <th>Crane</th>
            <th>Date</th>
            <th>Entries</th>
            <th>Total Hours</th>
            <th>Operating</th>
            <th>Delay</th>
            <th>Standby</th>
            <th>Maintenance</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody class="table-border-bottom-0">
          @foreach (var record in Model.Records)
          {
            <tr>
              <td><strong>@record.CraneCode</strong></td>
              <td>@record.Date.ToString("dd/MM/yyyy")</td>
              <td>@record.EntryCount entries</td>
              <td>@record.TotalHours.ToString("0.0") jam</td>
              <td>@record.OperatingHours.ToString("0.0") jam</td>
              <td>@record.DelayHours.ToString("0.0") jam</td>
              <td>@record.StandbyHours.ToString("0.0") jam</td>
              <td>@(record.ServiceHours + record.BreakdownHours).ToString("0.0") jam</td>
              <td>
                @if (record.IsFinalized)
                {
                  <span class="badge bg-success">Finalized</span>
                }
                else
                {
                  <span class="badge bg-warning">Draft</span>
                }
              </td>
              <td>
                <div class="dropdown">
                  <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                    <i class="bx bx-dots-vertical-rounded"></i>
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item"
                      href="@Url.Action("Form", new { craneId = record.CraneId, date = record.Date.ToString("yyyy-MM-dd") })">
                      <i class="bx bx-edit-alt me-1"></i> Edit
                    </a>
                    <a class="dropdown-item"
                      href="@Url.Action("MinuteVisualization", new { craneId = record.CraneId, date = record.Date.ToString("yyyy-MM-dd") })">
                      <i class="bx bx-bar-chart-alt me-1"></i> Visualize
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
  else
  {
    <div class="text-center py-5">
      <i class="bx bx-calendar-x text-secondary mb-2" style="font-size: 3rem;"></i>
      <p class="mb-0">No usage records found</p>
      <p class="text-muted">Click "Form" to create a new usage record</p>
    </div>
  }
</div>

<!-- Crane Selection Modal -->
<div class="modal fade" id="craneSelectionModal" tabindex="-1" aria-labelledby="craneSelectionModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form asp-action="SelectCraneAndDate" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="craneSelectionModalLabel">Select Crane and Date</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="craneId" class="form-label">Select Crane</label>
            <select name="craneId" id="craneId" class="form-select" required>
              <option value="">-- Select Crane --</option>
              @foreach (var crane in Model.Filter.CraneList)
              {
                <option value="@crane.Value">@crane.Text</option>
              }
            </select>
          </div>
          <div class="mb-3">
            <label for="date" class="form-label">Select Date</label>
            <input type="date" name="date" id="date" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")"
              required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Continue to Form</button>
        </div>
      </form>
    </div>
  </div>
</div>

@section PageScripts {
  <script>
    $(document).ready(function () {
      // Initialize DataTable
      $('#usageTable').DataTable({
        language: {
          url: '/lib/datatables/Indonesian.json'
        },
        order: [[1, 'desc']], // Sort by date desc
        responsive: true
      });
    });
  </script>
}
